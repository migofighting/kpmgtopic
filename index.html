<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT主题展示平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 添加EmailJS库 -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
        }
        
        /* 导航栏 */
        nav {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #444;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #2575fc;
        }
        
        /* 主题区域 */
        .topics-section {
            padding: 4rem 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 3rem;
            font-size: 2.2rem;
            color: #2c3e50;
        }
        
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .topic-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        
        .topic-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
        }
        
        .card-header h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card-body p {
            color: #666;
            margin-bottom: 1.5rem;
            min-height: 60px;
        }
        
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.3s, transform 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }

        /* 新增：表单样式 */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* 新增：咨询表单卡片样式 */
        .consultation-form-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-top: 1rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* 新增：消息提示样式 */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* 新增：服务类型选项样式 */
        .service-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .service-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .service-option:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .service-option.selected {
            border-color: #2ecc71;
            background: #d4edda;
        }
        
        .service-option h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .service-option p {
            color: #666;
            font-size: 0.9rem;
        }

        /* 新增：预约时间选择样式 */
        .time-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .time-slot {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .time-slot:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .time-slot.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        /* 页脚 */
        footer {
            background: #2c3e50;
            color: white;
            padding: 3rem 0 2rem;
            text-align: center;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            list-style: none;
        }
        
        .footer-links a {
            color: #ddd;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .copyright {
            margin-top: 2rem;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* 标签样式 */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #2ecc71;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .badge-new {
            background: #e74c3c;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .topics-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
            
            .service-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <h1 id="main-title">PPT主题展示平台</h1>
            <p class="subtitle">探索精彩主题，查看相关演示文稿</p>
        </div>
    </header>
    
    <!-- 导航栏 -->
    <nav>
        <div class="container nav-container">
            <div class="logo">
                <h2><i class="fas fa-book-open"></i> 知识库</h2>
            </div>
            <ul class="nav-links">
                <li><a href="#topics"><i class="fas fa-th-list"></i> 主题列表</a></li>
                <li><a href="#guide"><i class="fas fa-question-circle"></i> 使用指南</a></li>
                <li><a href="#consultation"><i class="fas fa-calendar-check"></i> 预约咨询</a></li>
                <li><a href="#upload-ppt"><i class="fas fa-upload"></i> 上传PPT</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- 主题展示区域 -->
    <section class="topics-section" id="topics">
        <div class="container">
            <h2 class="section-title">热门PPT主题</h2>
            <div class="topics-grid" id="topics-container">
                <!-- 主题卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- 新增：预约咨询区域 -->
    <section class="topics-section" id="consultation">
        <div class="container">
            <h2 class="section-title">预约专业咨询</h2>
            <div class="consultation-form-card">
                <p style="margin-bottom: 1.5rem; color: #666; text-align: center;">
                    <i class="fas fa-info-circle" style="color: #3498db;"></i>
                    填写以下信息，我们的专家将为您提供专业的咨询服务
                </p>
                
                <form id="consultationForm">
                    <div class="form-group">
                        <label for="customerName"><i class="fas fa-user"></i> 姓名 *</label>
                        <input type="text" id="customerName" name="customer_name" required placeholder="请输入您的姓名">
                    </div>
                    
                    <div class="form-group">
                        <label for="customerEmail"><i class="fas fa-envelope"></i> 邮箱地址 *</label>
                        <input type="email" id="customerEmail" name="customer_email" required placeholder="请输入您的邮箱地址">
                    </div>
                    
                    <div class="form-group">
                        <label for="customerPhone"><i class="fas fa-phone"></i> 联系电话 *</label>
                        <input type="tel" id="customerPhone" name="phone" required placeholder="请输入您的联系电话">
                    </div>
                    
                    <div class="form-group">
                        <label for="companyName"><i class="fas fa-building"></i> 公司名称</label>
                        <input type="text" id="companyName" name="company" placeholder="请输入您的公司名称">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-cogs"></i> 服务类型 *</label>
                        <div class="service-options">
                            <div class="service-option" data-value="数字化转型路线图规划" onclick="selectService(this)">
                                <h4>数字化转型路线图规划</h4>
                                <p>制定企业数字化转型战略和实施路径</p>
                            </div>
                            <div class="service-option" data-value="数据分析与商业智能" onclick="selectService(this)">
                                <h4>数据分析与商业智能</h4>
                                <p>数据挖掘、分析和可视化解决方案</p>
                            </div>
                            <div class="service-option" data-value="云计算架构设计" onclick="selectService(this)">
                                <h4>云计算架构设计</h4>
                                <p>云端基础设施和架构规划</p>
                            </div>
                            <div class="service-option" data-value="其他咨询服务" onclick="selectService(this)">
                                <h4>其他咨询服务</h4>
                                <p>其他定制化专业服务</p>
                            </div>
                        </div>
                        <input type="hidden" id="serviceType" name="service_type" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentDate"><i class="fas fa-calendar-alt"></i> 预约日期 *</label>
                        <input type="date" id="appointmentDate" name="appointment_date" required min="2024-01-01">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> 预约时间 *</label>
                        <div class="time-slots">
                            <div class="time-slot" data-time="09:00 - 10:00" onclick="selectTime(this)">09:00 - 10:00</div>
                            <div class="time-slot" data-time="10:30 - 11:30" onclick="selectTime(this)">10:30 - 11:30</div>
                            <div class="time-slot" data-time="14:00 - 15:00" onclick="selectTime(this)">14:00 - 15:00</div>
                            <div class="time-slot" data-time="15:30 - 16:30" onclick="selectTime(this)">15:30 - 16:30</div>
                            <div class="time-slot" data-time="其他时间" onclick="selectTime(this)">其他时间</div>
                        </div>
                        <input type="hidden" id="appointmentTime" name="appointment_time" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalInfo"><i class="fas fa-comment-dots"></i> 附加信息或特殊需求</label>
                        <textarea id="additionalInfo" name="additional_info" placeholder="请描述您的具体需求或问题..."></textarea>
                    </div>
                    
                    <div id="formMessage" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-paper-plane"></i> 提交预约申请
                    </button>
                    
                    <p style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-shield-alt"></i> 您的信息将严格保密，仅用于咨询服务
                    </p>
                </form>
            </div>
        </div>
    </section>

    <!-- PPT上传区域 -->
    <section class="topics-section" id="upload-ppt">
        <div class="container">
            <h2 class="section-title">上传您的PPT</h2>
            <div class="consultation-form-card">
                <p style="margin-bottom: 1.5rem; color: #666;">如果您有优秀的PPT想要分享，请填写以下信息：</p>
                
                <form id="pptUploadForm">
                    <div class="form-group">
                        <label for="userName"><i class="fas fa-user"></i> 您的姓名 *</label>
                        <input type="text" id="userName" name="user_name" required placeholder="请输入您的姓名">
                    </div>
                    
                    <div class="form-group">
                        <label for="userEmail"><i class="fas fa-envelope"></i> 电子邮箱 *</label>
                        <input type="email" id="userEmail" name="user_email" required placeholder="请输入您的邮箱">
                    </div>
                    
                    <div class="form-group">
                        <label for="userPhone"><i class="fas fa-phone"></i> 联系电话</label>
                        <input type="tel" id="userPhone" name="user_phone" placeholder="请输入您的联系电话">
                    </div>
                    
                    <div class="form-group">
                        <label for="pptTitle"><i class="fas fa-heading"></i> PPT标题 *</label>
                        <input type="text" id="pptTitle" name="ppt_title" required placeholder="请输入PPT标题">
                    </div>
                    
                    <div class="form-group">
                        <label for="pptDescription"><i class="fas fa-align-left"></i> PPT描述 *</label>
                        <textarea id="pptDescription" name="ppt_description" required placeholder="请详细描述您的PPT内容、适用场景等信息"></textarea>
                    </div>
                    
                    <div id="uploadMessage" style="display: none;"></div>
                    
                    <button type="submit" class="btn" style="width: 100%; padding: 1rem;">
                        <i class="fas fa-paper-plane"></i> 提交PPT信息
                    </button>
                </form>
            </div>
        </div>
    </section>
    
    <!-- 使用指南区域 -->
    <section class="topics-section" id="guide">
        <div class="container">
            <h2 class="section-title">使用指南</h2>
            <div class="guide-content">
                <div class="topic-card">
                    <div class="card-header">
                        <h3>如何查看PPT</h3>
                    </div>
                    <div class="card-body">
                        <p>点击主题卡片上的"查看PPT"按钮，即可直接在新窗口中打开PPT文件。</p>
                        <p>如果PPT无法打开，请联系网站管理员。</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 联系我们区域 -->
    <section class="topics-section" id="contact">
        <div class="container">
            <h2 class="section-title">联系我们</h2>
            <div class="topic-card">
                <div class="card-header">
                    <h3>获取帮助</h3>
                </div>
                <div class="card-body">
                    <p>如果您在查看PPT时遇到问题，或有其他疑问，请联系我们：</p>
                    <p>邮箱：contact@example.com</p>
                    <p>电话：+86 123-4567-8900</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 页脚 -->
    <footer>
        <div class="container footer-content">
            <div class="logo">
                <h2><i class="fas fa-chalkboard-teacher"></i> PPT主题展示平台</h2>
            </div>
            <ul class="footer-links">
                <li><a href="#topics">主题列表</a></li>
                <li><a href="#guide">使用指南</a></li>
                <li><a href="#consultation">预约咨询</a></li>
                <li><a href="#upload-ppt">上传PPT</a></li>
                <li><a href="#">隐私政策</a></li>
            </ul>
            <p class="copyright">© 2023 PPT主题展示平台. 保留所有权利.</p>
        </div>
    </footer>

    <script>
        // ==================== EmailJS 配置 ====================
        // 使用您提供的配置信息
        (function() {
            emailjs.init("LdXA13X-luabZOMlg"); // 您的Public Key
        })();

        const EMAILJS_CONFIG = {
            SERVICE_ID: "service_tgjhf2j",         // 您的Service ID
            CONSULTATION_TEMPLATE_ID: "template_wfd4dmp",  // 咨询表单模板
            UPLOAD_TEMPLATE_ID: "template_ppt_upload"      // PPT上传模板（需要您在EmailJS创建）
        };

        // ==================== 网站数据 ====================
        let topics = JSON.parse(localStorage.getItem('pptTopics')) || [
            { 
                id: 1, 
                title: "人工智能与机器学习", 
                description: "探索AI的最新发展，包括深度学习、自然语言处理等前沿技术", 
                pptUrl: "https://example.com/ai-presentation.pptx",
                category: "technology",
                uploader: "系统管理员"
            },
            { 
                id: 2, 
                title: "Web开发技术", 
                description: "前端与后端开发最新技术栈，包括React、Vue、Node.js等", 
                pptUrl: "https://example.com/web-dev.pptx",
                category: "technology",
                uploader: "系统管理员"
            },
            { 
                id: 3, 
                title: "数据科学与分析", 
                description: "从数据中提取价值的科学方法和实用工具", 
                pptUrl: null,
                category: "technology",
                uploader: "系统管理员"
            }
        ];

        // DOM元素
        const topicsContainer = document.getElementById('topics-container');
        const consultationForm = document.getElementById('consultationForm');
        const pptUploadForm = document.getElementById('pptUploadForm');
        const formMessage = document.getElementById('formMessage');
        const uploadMessage = document.getElementById('uploadMessage');

        // ==================== 页面初始化 ====================
        function initPage() {
            renderTopics();
            setupEventListeners();
            initDatePicker();
            loadSavedConsultations();
        }

        // 渲染主题卡片
        function renderTopics() {
            topicsContainer.innerHTML = '';
            
            topics.forEach(topic => {
                const topicCard = document.createElement('div');
                topicCard.className = 'topic-card';
                
                const hasPPT = topic.pptUrl ? `<span class="badge">可查看PPT</span>` : '';
                const isNew = topic.id > 3 ? `<span class="badge badge-new">新上传</span>` : '';
                
                topicCard.innerHTML = `
                    <div class="card-header">
                        <h3>${topic.title} ${hasPPT} ${isNew}</h3>
                        <p>${topic.description}</p>
                    </div>
                    <div class="card-body">
                        <p><strong>上传者:</strong> ${topic.uploader || '系统管理员'}</p>
                        <p><strong>分类:</strong> ${getCategoryName(topic.category)}</p>
                        <button class="btn" onclick="viewPPT(${topic.id})" ${!topic.pptUrl ? 'disabled' : ''}>
                            <i class="fas fa-external-link-alt"></i> 查看PPT
                        </button>
                        <button class="btn btn-warning" onclick="showConsultationForm(${topic.id})">
                            <i class="fas fa-info-circle"></i> 咨询相关服务
                        </button>
                    </div>
                `;
                topicsContainer.appendChild(topicCard);
            });
        }

        // 获取分类名称
        function getCategoryName(category) {
            const categories = {
                'technology': '技术开发',
                'business': '商业营销',
                'education': '教育教学',
                'design': '创意设计',
                'other': '其他'
            };
            return categories[category] || '未分类';
        }

        // ==================== 事件监听器设置 ====================
        function setupEventListeners() {
            // 咨询表单提交
            if (consultationForm) {
                consultationForm.addEventListener('submit', handleConsultationSubmit);
            }
            
            // PPT上传表单提交
            if (pptUploadForm) {
                pptUploadForm.addEventListener('submit', handlePPTUploadSubmit);
            }
        }

        // 初始化日期选择器
        function initDatePicker() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const dateInput = document.getElementById('appointmentDate');
            if (dateInput) {
                // 设置最小日期为明天
                const minDate = tomorrow.toISOString().split('T')[0];
                dateInput.min = minDate;
                
                // 设置默认日期为明天
                dateInput.value = minDate;
            }
        }

        // 选择服务类型
        function selectService(element) {
            // 移除所有选中状态
            document.querySelectorAll('.service-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 添加选中状态
            element.classList.add('selected');
            
            // 设置隐藏输入框的值
            const serviceTypeInput = document.getElementById('serviceType');
            if (serviceTypeInput) {
                serviceTypeInput.value = element.getAttribute('data-value');
            }
        }

        // 选择时间
        function selectTime(element) {
            // 移除所有选中状态
            document.querySelectorAll('.time-slot').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 添加选中状态
            element.classList.add('selected');
            
            // 设置隐藏输入框的值
            const timeInput = document.getElementById('appointmentTime');
            if (timeInput) {
                timeInput.value = element.getAttribute('data-time');
            }
        }

        // ==================== 咨询表单处理 ====================
        async function handleConsultationSubmit(e) {
            e.preventDefault();
            
            // 收集表单数据
            const formData = {
                customer_name: document.getElementById('customerName').value,
                customer_email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                company: document.getElementById('companyName').value || '未填写',
                service_type: document.getElementById('serviceType').value,
                appointment_date: document.getElementById('appointmentDate').value,
                appointment_time: document.getElementById('appointmentTime').value,
                additional_info: document.getElementById('additionalInfo').value || '无',
                submit_time: new Date().toLocaleString('zh-CN'),
                page_url: window.location.href,
                user_agent: navigator.userAgent.substring(0, 100)
            };
            
            // 验证必填字段
            if (!formData.service_type) {
                showMessage(formMessage, '请选择服务类型', 'error');
                return;
            }
            
            if (!formData.appointment_time) {
                showMessage(formMessage, '请选择预约时间', 'error');
                return;
            }
            
            // 显示加载状态
            showMessage(formMessage, '<i class="fas fa-spinner fa-spin"></i> 正在提交，请稍候...', 'loading');
            
            // 禁用提交按钮
            const submitBtn = consultationForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            
            try {
                // 使用EmailJS发送邮件
                const response = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.CONSULTATION_TEMPLATE_ID,
                    formData
                );
                
                if (response.status === 200) {
                    showMessage(formMessage, '✅ 预约提交成功！我们会尽快与您联系。', 'success');
                    
                    // 保存到本地存储（备份）
                    saveConsultationToLocal(formData);
                    
                    // 重置表单
                    setTimeout(() => {
                        consultationForm.reset();
                        resetFormSelections();
                        formMessage.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('EmailJS错误:', error);
                
                // 错误处理
                let errorMsg = '提交失败，请稍后重试。';
                
                if (error.text) {
                    if (error.text.includes('Invalid login')) {
                        errorMsg = '邮箱配置错误，请联系管理员。';
                    } else if (error.text.includes('quota')) {
                        errorMsg = '今日发送限额已满，请明天再试。';
                    }
                }
                
                showMessage(formMessage, `❌ ${errorMsg}`, 'error');
                
                // 备用方案：复制数据让用户手动发送
                manualEmailBackup(formData);
            } finally {
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 提交预约申请';
            }
        }

        // ==================== PPT上传表单处理 ====================
        async function handlePPTUploadSubmit(e) {
            e.preventDefault();
            
            const formData = {
                user_name: document.getElementById('userName').value,
                user_email: document.getElementById('userEmail').value,
                user_phone: document.getElementById('userPhone').value || '未提供',
                ppt_title: document.getElementById('pptTitle').value,
                ppt_description: document.getElementById('pptDescription').value,
                submit_time: new Date().toLocaleString('zh-CN'),
                page_url: window.location.href
            };
            
            // 显示加载状态
            showMessage(uploadMessage, '<i class="fas fa-spinner fa-spin"></i> 正在提交PPT信息...', 'loading');
            
            try {
                // 使用EmailJS发送邮件
                const response = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.UPLOAD_TEMPLATE_ID,
                    formData
                );
                
                if (response.status === 200) {
                    showMessage(uploadMessage, '✅ PPT信息已成功提交！管理员将审核您的上传。', 'success');
                    
                    // 保存到本地主题列表
                    savePPTToTopics(formData);
                    
                    // 重置表单
                    setTimeout(() => {
                        pptUploadForm.reset();
                        uploadMessage.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('EmailJS错误:', error);
                showMessage(uploadMessage, '❌ 提交失败，请稍后重试。', 'error');
            }
        }

        // ==================== 辅助函数 ====================
        // 显示消息
        function showMessage(element, message, type) {
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            element.style.display = 'block';
            
            // 如果是错误消息，10秒后自动隐藏
            if (type === 'error') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 10000);
            }
        }

        // 保存咨询信息到本地存储
        function saveConsultationToLocal(data) {
            try {
                let consultations = JSON.parse(localStorage.getItem('consultationSubmissions')) || [];
                consultations.push({
                    ...data,
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('consultationSubmissions', JSON.stringify(consultations));
                console.log('咨询信息已保存到本地存储，数量：', consultations.length);
            } catch (e) {
                console.log('本地存储失败：', e);
            }
        }

        // 加载保存的咨询信息
        function loadSavedConsultations() {
            try {
                const saved = JSON.parse(localStorage.getItem('consultationSubmissions')) || [];
                console.log('已保存的咨询记录：', saved.length, '条');
            } catch (e) {
                console.log('加载本地存储失败：', e);
            }
        }

        // 保存PPT到主题列表
        function savePPTToTopics(data) {
            const newTopic = {
                id: topics.length + 1,
                title: data.ppt_title,
                description: data.ppt_description,
                pptUrl: null,
                category: 'other',
                uploader: data.user_name,
                uploaderEmail: data.user_email,
                uploadDate: new Date().toISOString(),
                status: 'pending'
            };
            
            topics.push(newTopic);
            localStorage.setItem('pptTopics', JSON.stringify(topics));
            
            // 重新渲染
            renderTopics();
        }

        // 重置表单选择状态
        function resetFormSelections() {
            // 重置服务类型选择
            document.querySelectorAll('.service-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('serviceType').value = '';
            
            // 重置时间选择
            document.querySelectorAll('.time-slot').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('appointmentTime').value = '';
            
            // 重置日期为明天
            initDatePicker();
        }

        // 手动邮件备份（当EmailJS失败时）
        function manualEmailBackup(formData) {
            const mailSubject = `预约咨询：${formData.customer_name} - ${formData.service_type}`;
            const mailBody = `
姓名：${formData.customer_name}
邮箱：${formData.customer_email}
电话：${formData.phone}
公司：${formData.company}
服务类型：${formData.service_type}
预约日期：${formData.appointment_date}
预约时间：${formData.appointment_time}
附加信息：${formData.additional_info}

提交时间：${formData.submit_time}
            `.trim();
            
            // 复制到剪贴板
            navigator.clipboard.writeText(mailBody);
            
            // 询问用户是否手动发送
            setTimeout(() => {
                const shouldSend = confirm(
                    '自动提交遇到问题。\n\n' +
                    '信息已复制到剪贴板！\n\n' +
                    '是否打开邮箱手动发送？\n\n' +
                    '收件人：ay.yuan@kpmg.com\n' +
                    '主题：' + mailSubject
                );
                
                if (shouldSend) {
                    window.location.href = `mailto:ay.yuan@kpmg.com?subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(mailBody)}`;
                }
            }, 1000);
        }

        // 显示咨询表单
        function showConsultationForm(topicId) {
            const topic = topics.find(t => t.id === topicId);
            if (topic) {
                // 滚动到咨询表单
                document.getElementById('consultation').scrollIntoView({ behavior: 'smooth' });
                
                // 自动填充服务类型
                setTimeout(() => {
                    document.getElementById('additionalInfo').value = `我想咨询关于"${topic.title}"的相关服务。`;
                    document.getElementById('additionalInfo').focus();
                }, 500);
            }
        }

        // ==================== 原有功能 ====================
        // 查看PPT
        function viewPPT(topicId) {
            const topic = topics.find(t => t.id === topicId);
            if (topic && topic.pptUrl) {
                window.open(topic.pptUrl, '_blank');
            } else {
                alert('此主题暂无PPT文件，请稍后再试或联系管理员。');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
